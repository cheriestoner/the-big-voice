<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type= "text/css" href="{{ url_for('static', filename='style/audio_viz.css') }}">
        <title>Remix | The Big Voice</title>
    </head>
    <script src="https://d3js.org/d3.v7.js"></script>
    <body>
        <header>
            <div class="back">
                <button id="backButton"><</button>
            </div>
            <h1>Urban Sound Diary</h1>
        </header>
        <article>
            <div id="controls">
                <h3>{{ username }} sound map</h3>
                <div id="my_dataviz"></div>
            </div>
            <div class="controlTable">
                <table>
                    <tbody>
                        <tr id="volume-control">
                            <td style="padding: 15px 20px 20px; font-weight: 900;">
                                <label for="volumeSlider">VOLUME:</label>
                            </td>
                            <td style="padding: 15px 20px 20px 5px;">
                                <span>LOW</span>
                            </td>
                            <td class="wrapper" style="padding: 20px 0;">
                                <input type="range" id="volumeSlider" min="0.0" max="100" value="75">
                            </td>
                            <td style="padding: 15px 5px 20px 20px;">
                                <span>HIGH</span>
                            </td>
                        </tr>
                        <tr id="reverb-control">
                            <td style="padding: 15px 20px 20px; font-weight: 900;">
                                <label for="reverbSlider">REVERB:</label>
                            </td>
                            <td style="padding: 15px 20px 20px 5px;">
                                <span>DRY</span>
                            </td>
                            <td class="wrapper" style="padding: 20px 0;">
                                <input type="range" id="reverbSlider" min="0" max="100" value="25">
                            </td>
                            <td style="padding: 15px 5px 20px 20px; text-align: left;">
                                <span>WET</span>
                            </td>
                        </tr>
                        <tr id="filter-control">
                            <td style="padding: 15px 20px 20px; font-weight: 900;">
                                <label for="filterSlider">LOWPASS FILTER:</label>
                            </td>
                            <td style="padding: 15px 20px 20px 5px;">
                                <span>LOW</span>
                            </td>
                            <td class="wrapper" style="padding: 20px 0;">
                                <input type="range" id="filterSlider" min="50" max="15000" value="8000">
                            </td>
                            <td style="padding: 15px 5px 20px 20px;">
                                <span>HIGH</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </article>

    <!-- <svg id="myPlot" style="width:500px;height:500px"></svg> -->
    <!-- <script src="{{ url_for('static', filename='scatterplot-w3.js') }}"></script> -->
    <script>
        const backButton = document.getElementById('backButton');
        // d3 gallery https://d3-graph-gallery.com/graph/scatter_basic.html
        // set the dimensions and margins of the graph
        // 设置图表的尺寸和边距
        const margin = { top: 0, right: 0, bottom: 15, left: 25 };
        let width = window.innerWidth * 1 - margin.left - margin.right;
        let height = window.innerHeight * 0.6 - margin.top - margin.bottom;

        // 创建SVG对象
        const svg = d3.create("svg")
            .attr("viewBox", [0, 0, width + margin.left + margin.right, height + margin.top + margin.bottom])
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);

        // 追踪当前的缩放变换
        let currentTransform = d3.zoomIdentity;

        let x,
            y;
        
        d3.csv('/data/coords.csv').then(function(data) {
            const xvalues = data.map(d => +d.embedding_x);

            const xmaxValue = d3.max(xvalues);
            const xminValue = d3.min(xvalues);

            const yvalues = data.map(d => +d.embedding_y);

            const ymaxValue = d3.max(yvalues);
            const yminValue = d3.min(yvalues);

            // Add X axis
            x = d3.scaleLinear()
            .domain([xminValue * 1.05, xmaxValue * 1.05])
            .range([0, width]);

            // Add Y axis
            y = d3.scaleLinear()
            .domain([yminValue * 1.05, ymaxValue * 1.05])
            .range([height, 0]);

        }).catch(function(error) {
            console.error('读取 CSV 数据时出错:', error);
        });

        //const xAxis = d3.axisBottom(x);
        //const yAxis = d3.axisLeft(y);

        function zoomed(event) {
            currentTransform = event.transform;
            const zx = currentTransform.rescaleX(x).interpolate(d3.interpolateRound);
            const zy = currentTransform.rescaleY(y).interpolate(d3.interpolateRound);

            gDot.attr("transform", currentTransform).attr("stroke-width", 5 / currentTransform.k);
            //circle.attr("transform", currentTransform).attr("r", 50 * currentTransform.k);
            //gx.call(xAxis.scale(zx));
            //gy.call(yAxis.scale(zy));
        }

        const zoom = d3.zoom()
            .scaleExtent([0.75, 4])
            .on("zoom", zoomed);
        const vo = svg.append("path");
        const gDot = svg.append("g");
        const gx = svg.append("g")
            .attr("transform", `translate(${margin.left}, ${height + margin.top})`);
        const gy = svg.append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        d3.select("#my_dataviz").node().appendChild(svg.node());

        backButton.addEventListener('click', () => {
            window.location.href = '/index';
        });

        // 初始化 Web Audio API、混响节点和低通滤波器
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let reverbNode = audioContext.createConvolver();
        let filterNode = audioContext.createBiquadFilter();
        filterNode.type = 'lowpass';
        let volumeNode = audioContext.createGain();
        let dryGainNode = audioContext.createGain();
        let wetGainNode = audioContext.createGain();
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(1, audioContext.currentTime);

        // 在用户交互后恢复 AudioContext
        function resumeAudioContext() {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('AudioContext resumed.');
                });
            }
        }

        // 在用户首次交互时恢复 AudioContext
        document.body.addEventListener('click', resumeAudioContext, { once: true });

        // 加载 IR 文件，并将其应用到卷积节点
        fetch('/audio/cardiod-rear-levelled.wav')
            .then(response => response.arrayBuffer())
            .then(undecodedAudio => audioContext.decodeAudioData(undecodedAudio))
            .then(audioBuffer => {
                reverbNode.buffer = audioBuffer;
            })
            .catch(error => console.error('Error loading IR file:', error));
        
        const reverbSlider = document.getElementById('reverbSlider');
        reverbSlider.addEventListener('input', function () {
            let wetValue = this.value / 100;
            wetGainNode.gain.value = wetValue;
            dryGainNode.gain.value = 1 - wetValue;
        });

        const volumeSlider = document.getElementById('volumeSlider');
        volumeNode.gain.value = volumeSlider.value / 100;
        volumeSlider.addEventListener('input', function () {
            volumeNode.gain.value = this.value / 100;
        });

        const filterSlider = document.getElementById('filterSlider');
        filterNode.frequency.value = filterSlider.value;
        filterSlider.addEventListener('input', function () {
            filterNode.frequency.value = this.value;
        });

        d3.csv('/data/coords.csv').then(function(data) {
            // console.log(data);
            let audioFiles_raw = data.map(function(d) { return '/' + d.username + '/' + d.audiofile; });
            let audioFiles = Array.from(new Set(audioFiles_raw)); // merged repeated ones 
            console.log(audioFiles); 
            var audioElements = {}; // dictionary-like
            
            audioFiles.forEach((audioSrc, index) => { // /<username>/<filename>
                const audioElement = document.createElement('audio');
                audioElement.src = '/audio'.concat(audioSrc); // concat folder with filename
                document.body.appendChild(audioElement);
                // audioElements.push(audioElement); // for let audioElement = [];
                audioElements[audioSrc] = audioElement;

                let track = audioContext.createMediaElementSource(audioElement);
                track.connect(gainNode).connect(dryGainNode).connect(volumeNode).connect(filterNode).connect(audioContext.destination);
                track.connect(gainNode).connect(wetGainNode).connect(reverbNode).connect(audioContext.destination);
                //gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 3);
                //setTimeout(() => {
                //    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 3);
                //}, 10 * 1000);
            });

            console.log(audioElements);
            scatterplot_visualize(data, "#FF5C35", audioElements); 
        });

        function scatterplot_visualize(data, dotColor, audioElements) {
            /*
            dotColor: highlight sounds of the current user
            */
            const z = d3.scaleOrdinal()
                .domain(data.map(d => d.audiofile))
                .range(d3.schemeCategory10);

            // Add X & Y axis
            //gx.call(xAxis);
            //gy.call(yAxis);
        
            let isUserInteracted = false;
            // Listen for user interaction
            document.body.addEventListener('pointerdown', function () {
                isUserInteracted = true;
            });

            // Add dots
            gDot.selectAll("circle")
                .data(data)
                .join("circle")
                .attr("cx", d => x(d.embedding_x))
                .attr("cy", d => y(d.embedding_y))
                .attr("r", 5)
                .attr("fill", function(d) {return ((d.username == "{{ username }}")? dotColor : "#28713E")})
                .style("opacity", 0.5)
                // .style("stroke", "white")
                //.on("mouseover", function(event, d) {
                //    d3.select(this)
                //        .transition()
                //        .duration(200)
                //        .attr("r", 10);
                //
                //    if (isUserInteracted) {
                //        const startTime = parseFloat(d.start_time_sec);
                //        const endTime = parseFloat(d.end_time_sec);
                //        // console.log(startTime);
                //        if (!isNaN(startTime) && !isNaN(endTime) && startTime < endTime) {
                //            // Set audio to start time and play
                //            Object.values(audioElements).forEach(audio => {
                //                audio.pause();
                //                audio.currentTime = 0;
                //            });
                //            audioElements['/' + d.username + '/' + d.audiofile].currentTime = startTime;
                //            audioElements['/' + d.username + '/' + d.audiofile].play();
                //            // Calculate duration
                //            const duration = endTime - startTime;
                //            // Stop audio
                //            setTimeout(() => {
                //                audioElements['/' + d.username + '/' + d.audiofile].pause();
                //                audioElements['/' + d.username + '/' + d.audiofile].currentTime = 0; // Reset to start
                //            }, duration * 1000); // Convert duration to milliseconds
                //        } else {
                //            console.error("Invalid start or end time:", d.start_time_sec, d.end_time_sec);
                //        }
                //    }
                //})
                //.on("mouseleave", function(event, d) {
                //    d3.select(this)
                //    .transition()
                //    .duration(200)
                //    .attr("r", 5);
                //    //停止播放
                //    audioElements['/' + d.username + '/' + d.audiofile].pause();
                //    audioElements['/' + d.username + '/' + d.audiofile].currentTime = 0; //重置
                //});
            
            // 应用缩放行为到 SVG
            svg.call(zoom);

            svg.on("click", function(event) {
                // 获取点击位置
                const [clickX, clickY] = d3.pointer(event);
                const transformedX = currentTransform.invertX(clickX);
                const transformedY = currentTransform.invertY(clickY);

                //const scaledRadius = 50 * currentTransform.k;

                // 添加一个新的圆圈到点击位置
                const circle = svg.append("circle")
                    .attr("cx", clickX)
                    .attr("cy", clickY)
                    .attr("r", 50)
                    .attr("stroke", "#00000080")
                    .attr("stroke-width", 3)
                    .attr("fill", "#77777780")
                    .attr("fill-opacity", 1)
                    .attr("stroke-opacity", 1)
                    .attr("class", "selection-circle");

                const pointsInCircle = [];
                gDot.selectAll("circle").each(function(d) {
                    const cx = x(d.embedding_x);
                    const cy = y(d.embedding_y);
                    const distance = Math.sqrt((currentTransform.applyX(cx) - clickX) ** 2 + (currentTransform.applyY(cy) - clickY) ** 2);
                    if (distance <= 50) {
                        pointsInCircle.push(d);
                    }
                });
            
                // 打乱顺序，随机播放点的音频
                const shuffledPoints = d3.shuffle(pointsInCircle);
            
                function playNextAudio(index, totalDuration) {
                    
                    if (totalDuration >= 10000) {
                        console.log("Total play time exceeded 10 seconds, stopping playback.");
                        return;
                    }
                    if (shuffledPoints.length === 0) {
                        console.error("No points found in the selected circle.");
                        return;
                    }
                    if (index >= shuffledPoints.length) {
                        index = 0;
                    }
                
                    const d = shuffledPoints[index];
                    if (!d || !audioElements['/' + d.username + '/' + d.audiofile]) {
                        console.error("Invalid point or audio file not found:", d);
                        playNextAudio(index + 1, totalDuration);
                        return;
                    }
                
                    const audioElement = audioElements['/' + d.username + '/' + d.audiofile];
                    const startTime = parseFloat(d.start_time_sec);
                    const endTime = parseFloat(d.end_time_sec);
                
                    if (!isNaN(startTime) && !isNaN(endTime) && startTime < endTime) {
                        audioElement.currentTime = startTime;
                        audioElement.play();
                        const duration = Math.min(endTime - startTime, 10 - totalDuration / 1000);

                        //setTimeout(() => {
                        //    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 3);
                        //}, 2000);
                
                        setTimeout(() => {
                            audioElement.pause();
                            audioElement.currentTime = 0;
                
                            totalDuration += duration * 1000;
                            playNextAudio(index + 1, totalDuration);
                        }, duration * 1000);
                    } else {
                        // 如果音频数据无效，跳到下一个
                        console.error("Invalid start or end time for audio:", startTime, endTime);
                        playNextAudio(index + 1, totalDuration);
                    }
                }
                
                playNextAudio(0, 0);

                setTimeout(() => {
                    circle.transition()
                        .duration(10000)
                        .attr("fill-opacity", 0)
                        .attr("stroke-opacity", 0)
                        .remove();
                }, 2000);
            });
        }
    </script>
    <!-- <script src="{{ url_for('static', filename='scatterplot.js') }}"></script> -->

    </body>
</html>
