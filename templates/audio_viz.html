<!-- <!DOCTYPE html>
<html>
<script src="https://d3js.org/d3.v7.js"></script>
<body>
<h2>Scatter-Plot</h2>

<div id="d3_scatterplot"></div>

<script src="static/scatterplot.js"></script>

</body>
</html> -->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" type= "text/css" href="{{ url_for('static', filename='style/audio_viz.css') }}">
        <link rel="shortcut icon" href="/favicon.ico"/>
        <title>Remix | The Big Voice</title>
    </head>
    <script src="https://d3js.org/d3.v7.js"></script>
    <body>
        <header>
            <h1>The Big Voice</h1>
        </header>
        <article>
            <button id='backtoRecorder'> ⬅ Back to Recorder</button>
            <div id="controls">
                <h3>{{ audiofile }} in scatterplot</h3>
                <div id="my_dataviz"></div>
            </div>
        </article>

        <footer class="body-foot">
            <div class="foot-container">
                <div class="catagories">
                    <div class="column">
                        <a href="https://soundstudiesgroup.net/" target="_blank">Sound Studies Group</a>
                    </div>
                    <div class="column">
                        <a href="https://soundstudiesgroup.net/" target="_blank">Related Links</a>
                    </div>
                    <div class="column">
                        <a href="https://soundstudiesgroup.net/" target="_blank">About</a>
                    </div>
                </div>
            </div>
            <div class="foot-bottom">
                Copyright © 2024, Sound Studies Group, SUSTech
            </div>
        </footer>

<!-- <svg id="myPlot" style="width:500px;height:500px"></svg> -->
<!-- <script src="{{ url_for('static', filename='scatterplot-w3.js') }}"></script> -->
    <script> 
        const backButton = document.getElementById('backtoRecorder');
        // d3 gallery https://d3-graph-gallery.com/graph/scatter_basic.html
        // set the dimensions and margins of the graph
        const margin = {top: 10, right: 30, bottom: 30, left: 60},
                width = 720 - margin.left - margin.right,
                height = 640 - margin.top - margin.bottom;

        // 创建SVG对象
        const svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        //Read the data
        // csvParseRows: without header
        // d3.text('data/xyz.csv').then(function(text) {
        //     data = d3.csvParseRows(text);
        //     scatterplot_visualize(data);
        // })

        // var test_data = JSON.parse('{{ feed_data | safe }}');
        // console.log(test_data);

        // d3.csv('/data/{{audiofile}}/data.csv').then()

        backButton.addEventListener('click', () => {
            window.location.href='/';
        });

        const csvPath = ['/data/{{ audiofile }}/data.csv', '/data/test_office/test1.csv', '/data/test_office/test2.csv', '/data/test_office/test3.csv', '/data/test_office/test4.csv'];
        const audioFile = ['/audio/{{ audiofile }}.wav', '/audio/test1.wav', '/audio/test2.wav', '/audio/test3.wav', '/audio/test4.wav'];
        const color = ['#24d00a', '#563f2e', '#f7c242', '#bec23f', '#000000bc'];

        // Create an audio element
        let audioElements = [];
        audioFile.forEach((audioSrc, index) => {
            const audioElement = document.createElement('audio');
            audioElement.src = audioSrc;
            document.body.appendChild(audioElement);
            audioElements.push(audioElement);
        });

        csvPath.forEach((csvPath, index) => {
            d3.csv(csvPath).then(function(data) {
                scatterplot_visualize(data, color[index], audioElements[index]);
            });
        });

        function scatterplot_visualize(data, dotColor, audioElement) {
            // Add X axis
            const x = d3.scaleLinear()
            .domain([0, 1])
            .range([ 0, width ]);
            svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x));

            // Add Y axis
            const y = d3.scaleLinear()
            .domain([0, 1])
            .range([ height, 0]);
            svg.append("g")
            .call(d3.axisLeft(y));

            let isUserInteracted = false;
            // Listen for user interaction
            document.body.addEventListener('pointerdown', function () {
                isUserInteracted = true;
            });
            
            // Add dots
            svg.append('g')
            .selectAll("dot")
            .data(data)
            .join("circle")
                .attr("cx", function (d) { return x(d.centroid); } )
                .attr("cy", function (d) { return y(d.rms); } )
                .attr("r", 7.5)
                .style("fill", dotColor)
            
                .on("mouseover", function(event, d) {
                    d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("r", 15);

                    if (isUserInteracted) {
                        const startTime = parseFloat(d.start_time_sec);
                        const endTime = parseFloat(d.end_time_sec);
                        console.log(startTime);
                        if (!isNaN(startTime) && !isNaN(endTime) && startTime < endTime) {
                            // Set audio to start time and play
                            audioElement.currentTime = startTime;
                            audioElement.play();
                            // Calculate duration
                            const duration = endTime - startTime;
                            // Stop audio
                            setTimeout(() => {
                                audioElement.pause();
                                audioElement.currentTime = 0; // Reset to start
                            }, duration * 1000); // Convert duration to milliseconds
                        } else {
                            console.error("Invalid start or end time:", d.start_time_sec, d.end_time_sec);
                        }
                    }
                })
                .on("mouseleave", function(event, d) {
                    d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("r", 7.5);
                    //停止播放
                    audioElement.pause();
                    audioElement.currentTime = 0; //重置
                })
        }
    </script>
    <!-- <script src="{{ url_for('static', filename='scatterplot.js') }}"></script> -->

    </body>
</html>
